<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="MemberCard.Pages.HistoryPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:local="clr-namespace:MemberCard.Pages"
    Title="Riwayat Point"
    BackgroundColor="{DynamicResource ColorBackground}"
    Padding="8,0">

    <!-- pakai converter kamu yang sudah ada -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <local:TanggalPrettyConverter x:Key="TanggalPretty" />
            <local:IsNegativeConverter x:Key="IsNegative" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- biarkan RefreshView selalu enabled; kita tak pakai converter NOT -->
    <RefreshView x:Name="HistoryRefresh" Refreshing="OnRefresh">
        <CollectionView x:Name="List"
                        Margin="0"
                        SelectionMode="None"
                        ItemsLayout="VerticalList"
                        VerticalScrollBarVisibility="Never"
                        ItemsSource="{Binding Items}">

            <!-- Saat pertama kali: tampilkan SPINNER (IsLoading=true).
                 Pesan kosong (Label) baru terlihat saat ShowEmptyMessage=true
                 setelah loading selesai dan Items.Count == 0. -->
            <CollectionView.EmptyView>
                <Grid Padding="16" RowDefinitions="Auto,Auto">
                    <ActivityIndicator
                        IsRunning="True"
                        IsVisible="{Binding IsLoading}"
                        Color="{DynamicResource ColorText}" />
                    <Label Grid.Row="1"
                           IsVisible="{Binding ShowEmptyMessage}"
                           Text="Belum ada riwayat. Tarik ke bawah untuk menyegarkan."
                           HorizontalTextAlignment="Center"
                           Margin="0,8,0,0"
                           TextColor="{DynamicResource ColorText}" />
                </Grid>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <!-- LIST item: padding kecil + separator berjarak -->
                    <Grid Padding="8,10"
                          RowDefinitions="Auto,Auto,Auto"
                          ColumnDefinitions="24,8,*">

                        <!-- ICON PNG KIRI: plus/minus -->
                        <Image Grid.Row="0" Grid.Column="0" Grid.RowSpan="2"
                               HeightRequest="20" WidthRequest="20"
                               VerticalOptions="Start"
                               Source="ic_point_plus.png">
                            <Image.Triggers>
                                <DataTrigger TargetType="Image"
                                             Binding="{Binding Point, Converter={StaticResource IsNegative}}"
                                             Value="True">
                                    <Setter Property="Source" Value="ic_point_minus.png" />
                                </DataTrigger>
                            </Image.Triggers>
                        </Image>

                        <!-- KONTEN KANAN -->
                        <Grid Grid.Column="2" RowDefinitions="Auto,Auto">
                            <!-- BARIS 1: Keterangan — Rp Total -->
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="{Binding Keterangan}"
                                       FontAttributes="Bold" FontSize="15"
                                       LineBreakMode="TailTruncation"
                                       TextColor="{DynamicResource ColorText}" />
                                <Label Grid.Column="1"
                                       IsVisible="{Binding ShowTotal}"
                                       Text="{Binding Total, StringFormat='Rp {0:N0}'}"
                                       FontSize="14" FontAttributes="Bold"
                                       HorizontalTextAlignment="End"
                                       TextColor="{DynamicResource ColorText}" />
                            </Grid>

                            <!-- BARIS 2: Tanggal — Poin: xxx (minus merah) -->
                            <Grid Grid.Row="1" ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="{Binding Tanggal, Converter={StaticResource TanggalPretty}}"
                                       FontSize="12" Opacity=".85"
                                       TextColor="{DynamicResource ColorText}" />
                                <Label Grid.Column="1"
                                       Text="{Binding Point, StringFormat='Poin : {0:N0}'}"
                                       FontAttributes="Bold" FontSize="12"
                                       HorizontalTextAlignment="End"
                                       TextColor="{DynamicResource ColorText}">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label"
                                                     Binding="{Binding Point, Converter={StaticResource IsNegative}}"
                                                     Value="True">
                                            <Setter Property="TextColor" Value="#DC2626" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </Grid>
                        </Grid>

                        <!-- SEPARATOR: mulai setelah ikon + ada jarak dari teks -->
                        <BoxView Grid.Row="2" Grid.Column="2"
                                 HeightRequest="1"
                                 Margin="0,8,0,0"
                                 HorizontalOptions="Fill"
                                 BackgroundColor="{DynamicResource ColorSecondary}"
                                 Opacity="0.15" />
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </RefreshView>
</ContentPage>
